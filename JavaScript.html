<!-- JavaScript.html -->
    <script>
    // Main application controller
    class UIDemoController {
      constructor() {
        this.initElements();
        this.loadImageClientSideOnly();
        this.bindEvents();
        
        // Configuration: Choose when to show the image
        this.config = {
          showImageOnLoad: true,     // Show image when page loads
          showImageOnButtonClick: true, // Show image when button is clicked
          imageFloatOnLoad: true     // Add floating animation on load
        };
        
        this.startSequence();
      }
      
      /**
       * Cache DOM elements for performance
       */
      initElements() {
        this.body = document.body;
        this.container = document.querySelector('.container');
        this.usernameInput = document.getElementById('username');
        this.passwordGroup = document.getElementById('password-group');
        this.passwordInput = document.getElementById('password');
        this.actionBtn = document.getElementById('action-btn');
        this.demoImage = document.getElementById('demoImage');
        this.overlay = document.getElementById('overlay');
        this.isTransitioning = false;
        this.imageVisible = false;
      }
      
      /**
      * Load PNG image from server (dropbox)
      */
      loadImageClientSideOnly() {
      const dropboxLink =
      'https://www.dropbox.com/scl/fi/v7bj219c4sz7irj4uxsvy/Design.png?rlkey=mmqgbxk3wj6bilaxt6wz90mro&st=p7ae6xdq&dl=1';
      
      // Atribui o link diretamente ao src.
      // O navegador se encarrega de fazer a requisição HTTP GET para o Dropbox.
      this.demoImage.src = dropboxLink;
      
      // Opcional: Adicionar listeners para sucesso/falha no carregamento
      this.demoImage.onload = () => {
      console.log('Imagem carregada com sucesso diretamente do Dropbox.');
      };
      
      this.demoImage.onerror = (error) => {
      console.error('Falha ao carregar a imagem do Dropbox:', error);
      // Implemente um fallback local se necessário
      };
      }
      
      /**
      * Bind event listeners to UI elements
      */
      bindEvents() {
        // Username input events
        this.usernameInput.addEventListener('input', () => this.handleUsernameInput());
        this.usernameInput.addEventListener('keydown', (e) => this.handleUsernameKeydown(e));
        this.usernameInput.addEventListener('focus', () => this.handleUsernameFocus());
        
        // Password input events
        this.passwordInput.addEventListener('input', () => this.handlePasswordInput());
        this.passwordInput.addEventListener('keydown', (e) => this.handlePasswordKeydown(e));
        
        // Button click event
        this.actionBtn.addEventListener('click', () => this.handleButtonClick());
        
        // Window resize handling
        window.addEventListener('resize', () => this.handleResize());
      }
      
      /**
       * Start the initial UI animation sequence
       */
      startSequence() {
        // Show image on load if configured
        if (this.config.showImageOnLoad && !this.imageVisible) {
          setTimeout(() => {
            this.showImage();
            
            // Hide image after 3 seconds and start the rest of the sequence
            setTimeout(() => {
              this.hideImage();
              this.startMainSequence();
            }, 3000);
          }, 500);
        } else {
          this.startMainSequence();
        }
      }
      
      /**
       * Start the main login sequence
       */
      startMainSequence() {
        // Initial background transition to wine red
        setTimeout(() => {
          this.body.style.backgroundColor = 'var(--wine-red)';
          
          // Fade in container and elements
          setTimeout(() => {
            this.container.style.opacity = '1';
            this.container.style.transform = 'translateY(0)';
            
            // Animate username input
            setTimeout(() => {
              this.usernameInput.classList.add('fade-in');
              
              // Animate button
              setTimeout(() => {
                this.actionBtn.classList.add('fade-in');
              }, 300);
            }, 200);
          }, 300);
        }, 100);
      }
      
      /**
       * Show the PNG image with animation
       */
      showImage(options = {}) {
        if (this.imageVisible) return;
        
        this.imageVisible = true;
        
        // Remove any existing animation classes
        this.demoImage.classList.remove('image-exit');
        this.demoImage.classList.remove('image-float');
        
        // Add overlay for background dim
        if (options.dimBackground) {
          this.overlay.classList.add('active');
        }
        
        // Hide main container while image is showing
        if (options.hideContainer) {
          this.container.style.opacity = '0';
          this.container.style.pointerEvents = 'none';
        }
        
        // Add enter animation
        setTimeout(() => {
          this.demoImage.classList.add('image-enter');
          
          // Add floating animation if configured
          if (this.config.imageFloatOnLoad) {
            setTimeout(() => {
              this.demoImage.classList.add('image-float');
            }, 1200);
          }
        }, 50);
      }
      
      /**
       * Hide the PNG image with animation
       */
      hideImage() {
        if (!this.imageVisible) return;
        
        this.imageVisible = false;
        
        // Remove animation classes
        this.demoImage.classList.remove('image-enter');
        this.demoImage.classList.remove('image-float');
        
        // Add exit animation
        this.demoImage.classList.add('image-exit');
        
        // Remove overlay
        this.overlay.classList.remove('active');
        
        // Show main container again
        this.container.style.opacity = '1';
        this.container.style.pointerEvents = 'all';
        
        // Reset image after animation completes
        setTimeout(() => {
          this.demoImage.classList.remove('image-exit');
        }, 1000);
      }
      
      /**
       * Handle username input changes
       */
      handleUsernameInput() {
        if (this.usernameInput.value.length > 0 && !this.passwordGroup.classList.contains('fade-in')) {
          // Change button text to "Login"
          this.actionBtn.textContent = 'Login';
          
          // Show password field with animation
          this.passwordGroup.classList.remove('hidden');
          setTimeout(() => {
            this.passwordGroup.classList.add('fade-in');
            this.passwordInput.classList.add('fade-in');
          }, 10);
        } else if (this.usernameInput.value.length === 0) {
          // Revert to initial state if username is empty
          this.actionBtn.textContent = 'cadastre-me';
          this.passwordGroup.classList.remove('fade-in');
          setTimeout(() => {
            this.passwordGroup.classList.add('hidden');
          }, 300);
        }
      }
      
      /**
       * Handle username field focus
       */
      handleUsernameFocus() {
        // Ensure button shows correct text when focused
        if (this.usernameInput.value.length > 0) {
          this.actionBtn.textContent = 'Login';
        }
      }
      
      /**
       * Handle Tab or Enter in username field
       */
      handleUsernameKeydown(e) {
        if ((e.key === 'Tab' || e.key === 'Enter') && this.usernameInput.value.length > 0) {
          e.preventDefault();
          
          // Show password field if not visible
          if (this.passwordGroup.classList.contains('hidden')) {
            this.handleUsernameInput();
          }
          
          // Focus password field
          setTimeout(() => {
            this.passwordInput.focus();
          }, 50);
        }
      }
      
      /**
       * Handle password input - trigger background color change
       */
      handlePasswordInput() {
        if (this.passwordInput.value.length > 0 && !this.isTransitioning) {
          this.isTransitioning = true;
          
          // Transition background from red to dark green
          this.body.style.backgroundColor = 'var(--dark-green)';
          // Change button to light green variant
            this.updateButtonColor('light-green', 'Login');

          // Reset transition lock after completion
          setTimeout(() => {
            this.isTransitioning = false;
          }, 1500);
        } else if (this.passwordInput.value.length === 0 && this.isTransitioning) {
          // Revert to red if password is cleared
          this.body.style.backgroundColor = 'var(--wine-red)';
          this.isTransitioning = false;

    
    // Determine button color based on username input
    const usernameValue = this.usernameInput.value;
    
    if (usernameValue.length > 0) {
      // Username exists, no password - use light red
      this.updateButtonColor('light-red', 'Login');
    } else {
      // No inputs at all - revert to default red
      this.updateButtonColor('default', 'cadastre-me');
          }
        }
      }
      /**
 * Update button color and text based on state
 * @param {string} variant - 'default', 'light-red', or 'light-green'
 * @param {string} text - Button text to display
 */
updateButtonColor(variant, text) {
  // Remove all color classes
  this.actionBtn.classList.remove('light-red', 'light-green');
  
  // Add the appropriate color class
  if (variant === 'light-red') {
    this.actionBtn.classList.add('light-red');
  } else if (variant === 'light-green') {
    this.actionBtn.classList.add('light-green');
  }
  // If variant is 'default', we just remove the classes
  
  // Update button text with smooth transition
  this.actionBtn.textContent = text;
}

/**
 * Updated: Handle username input changes
 */
handleUsernameInput() {
  const usernameValue = this.usernameInput.value;
  const passwordValue = this.passwordInput.value;
  const hasUsername = usernameValue.length > 0;
  const hasPassword = passwordValue.length > 0;
  
  if (hasUsername && !this.passwordGroup.classList.contains('fade-in')) {
    // Show password field with animation
    this.passwordGroup.classList.remove('hidden');
    setTimeout(() => {
      this.passwordGroup.classList.add('fade-in');
      this.passwordInput.classList.add('fade-in');
    }, 10);
  }
  
  // Update button based on input states
  if (hasUsername && hasPassword) {
    // Both fields have content
    this.updateButtonColor('light-green', 'Login');
  } else if (hasUsername && !hasPassword) {
    // Only username has content
    this.updateButtonColor('light-red', 'Login');
  } else if (!hasUsername && !hasPassword) {
    // No content in either field
    this.updateButtonColor('default', 'cadastre-me');
    
    // Hide password field if empty
    this.passwordGroup.classList.remove('fade-in');
    setTimeout(() => {
      this.passwordGroup.classList.add('hidden');
    }, 300);
  }
  // Note: hasPassword without username shouldn't happen naturally
}

      /**
       * Handle Enter in password field
       */
      handlePasswordKeydown(e) {
        if (e.key === 'Enter' && this.passwordInput.value.length > 0) {
          this.handleButtonClick();
        }
      }
      
      /**
 * Handle login/register button click
 */
async handleButtonClick() {
  // Prevent multiple clicks during transition
  if (this.isTransitioning) return;
  
  this.isTransitioning = true;
  
  const buttonText = this.actionBtn.textContent;
  const username = this.usernameInput.value.trim();
  const password = this.passwordInput.value.trim();
  
  // Show loading state
  this.actionBtn.textContent = 'Processando...';
  this.actionBtn.disabled = true;
  
  try {
    if (buttonText === 'cadastre-me') {
      // Show registration form
      await this.showRegistrationForm();
    } else if (buttonText === 'Login') {
      // Perform login
      await this.performLogin(username, password);
    }
  } catch (error) {
    console.error('Action failed:', error);
    this.showError(error.message || 'Ocorreu um erro. Tente novamente.');
    this.actionBtn.textContent = buttonText;
    this.actionBtn.disabled = false;
    this.isTransitioning = false;
  }
}

/**
 * Perform login via API
 */
async performLogin(username, password) {
  if (!username || !password) {
    throw new Error('Por favor, preencha usuário e senha');
  }
  
  // Show image during login
  if (this.config.showImageOnButtonClick) {
    this.showImage({
      dimBackground: true,
      hideContainer: true
    });
  }
  
  try {
    // Call server-side login function
    const result = await new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .api_login(username, password);
    });
    
    const data = JSON.parse(result.getContent());
    
    if (data.success) {
      // Redirect to dashboard with session
      window.location.href = data.redirectUrl;
    } else {
      throw new Error(data.error || 'Login falhou');
    }
  } catch (error) {
    this.hideImage();
    throw error;
  }
}

/**
 * Show registration form
 */
async showRegistrationForm() {
  this.body.style.backgroundColor = 'var(--wine-red)';
  this.container.style.transform = 'translateY(20px) scale(0.95)';
  
  // Transition to registration view
  this.container.style.opacity = '0';
  
  setTimeout(() => {
     
      
    
    // Replace form content with registration fields
    const loginBox = document.querySelector('.login-box');
    loginBox.innerHTML = `
      <div class="register-box">
  <h2 class="form-title">Cadastro</h2>

  <div class="input-group">
    <i class="input-icon fas fa-user"></i>
    <input
      type="text"
      id="reg-username"
      class="input-field fade-in"
      placeholder="nome de usuário"
      autocomplete="off"
          style="border: 2px solid rgba(139, 0, 0, 0.3); box-shadow: 0 2px 8px rgba(0,0,0,0.2);"
        >
      </div>
      
      <div class="input-group">
    <i class="input-icon fas fa-envelope"></i>
    <input
      type="email"
      id="reg-email"
      class="input-field fade-in"
      placeholder="email"
      autocomplete="off"
          style="border: 2px solid rgba(139, 0, 0, 0.3); box-shadow: 0 2px 8px rgba(0,0,0,0.2);"
        >
      </div>
      
      <div class="input-group">
    <i class="input-icon fas fa-lock"></i>
    <input
      type="password"
      id="reg-password"
      class="input-field fade-in"
      placeholder="senha"
      autocomplete="off"
          style="border: 2px solid rgba(139, 0, 0, 0.3); box-shadow: 0 2px 8px rgba(0,0,0,0.2);"
        >
      </div>
      
      <div class="input-group">
    <i class="input-icon fas fa-lock"></i>
    <input
      type="password"
      id="reg-password-confirm"
      class="input-field fade-in"
      placeholder="confirmar senha"
      autocomplete="off"
          style="border: 2px solid rgba(139, 0, 0, 0.3); box-shadow: 0 2px 8px rgba(0,0,0,0.2);"
        >
      </div>
      
      
      <button id="register-btn" class="action-btn fade-in primary">
    Criar Conta
  </button>
     
  <button id="back-btn" class="action-btn fade-in secondary">
    Voltar
  </button>
</div>
    `;
    
    // Fade in with new colors
      setTimeout(() => {
        this.container.style.opacity = '1';
      }, 50);
    
    // Bind new events
    document.getElementById('register-btn').addEventListener('click', () => this.performRegistration());
    document.getElementById('back-btn').addEventListener('click', () => this.handleBackButton());
    
    this.isTransitioning = false;
  }, 500);
}
/**
 * 
 * Handle back button - return to login with color reversal
 */
handleBackButton() {
  // Prevent multiple clicks
  if (this.isTransitioning) return;
  this.isTransitioning = true;
  
  // Fade out container
  this.container.style.opacity = '0';
  
  setTimeout(() => {
    // 
    //this.container.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
    //this.container.style.boxShadow = '0 8px 32px rgba(0, 0, 0, 0.1)';
    
    // Restore original login form
    const loginBox = document.querySelector('.login-box');
    loginBox.innerHTML = `
      <div class="input-group">
        <i class="input-icon fas fa-user"></i>
        <input 
          type="text" 
          id="username" 
          class="input-field" 
          placeholder="nome de usuário (Ou clique abaixo em cadastre-me)"
          autocomplete="off"
        >
      </div>
      
      <div class="input-group hidden" id="password-group">
        <i class="input-icon fas fa-lock"></i>
        <input 
          type="password" 
          id="password" 
          class="input-field" 
          placeholder="senha"
          autocomplete="off"
        >
      </div>
      
      <button id="action-btn" class="action-btn">cadastre-me</button>
    `;
    
    // Re-initialize elements
    this.initElements();
    this.bindEvents();
    
    // Call proceedWithReset to restore login state
    this.proceedWithReset();
  }, 500);
}
/**
 * Perform registration via API
 */
async performRegistration() {
  const username = document.getElementById('reg-username').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const password = document.getElementById('reg-password').value.trim();
  const passwordConfirm = document.getElementById('reg-password-confirm').value.trim();
  
  // Validation
  if (!username || !email || !password || !passwordConfirm) {
    this.showError('Por favor, preencha todos os campos');
    return;
  }
  
  if (password !== passwordConfirm) {
    this.showError('As senhas não coincidem');
    return;
  }
  
  if (password.length < 6) {
    this.showError('A senha deve ter pelo menos 6 caracteres');
    return;
  }
  
  // Show loading
  const registerBtn = document.getElementById('register-btn');
  registerBtn.textContent = 'Criando conta...';
  registerBtn.disabled = true;
  
  try {
    // Call server-side registration function
    const result = await new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .api_register(username, password, email, 'CLIENT');
    });
    
    const data = JSON.parse(result.getContent());
    
    if (data.success) {
      // Show success message
      this.showSuccess('Conta criada com sucesso!');
      
      // Redirect to dashboard
      setTimeout(() => {
        window.location.href = data.redirectUrl;
      }, 1500);
    } else {
      throw new Error(data.error || 'Cadastro falhou');
    }
  } catch (error) {
    registerBtn.textContent = 'Criar Conta';
    registerBtn.disabled = false;
    this.showError(error.message || 'Erro ao criar conta');
  }
}

/**
 * Show error message
 */
showError(message) {
  // Create error element if it doesn't exist
  let errorDiv = document.getElementById('error-message');
  if (!errorDiv) {
    errorDiv = document.createElement('div');
    errorDiv.id = 'error-message';
    errorDiv.style.cssText = `
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #d32f2f;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 10000;
      animation: slideDown 0.3s ease;
    `;
    document.body.appendChild(errorDiv);
  }
  
  errorDiv.textContent = message;
  errorDiv.style.display = 'block';
  
  // Auto-hide after 4 seconds
  setTimeout(() => {
    errorDiv.style.display = 'none';
  }, 4000);
}

/**
 * Show success message
 */
showSuccess(message) {
  let successDiv = document.getElementById('success-message');
  if (!successDiv) {
    successDiv = document.createElement('div');
    successDiv.id = 'success-message';
    successDiv.style.cssText = `
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #2e7d32;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 10000;
      animation: slideDown 0.3s ease;
    `;
    document.body.appendChild(successDiv);
  }
  
  successDiv.textContent = message;
  successDiv.style.display = 'block';
  
  setTimeout(() => {
    successDiv.style.display = 'none';
  }, 4000);
}
      
      /**
       * Proceed with reset sequence after image display
       */
      proceedWithReset() {
        // Hide image if it's visible
        if (this.imageVisible) {
          this.hideImage();
        }
        // Reset button to default color
        this.updateButtonColor('default', 'cadastre-me');

        // Fade out all elements
        this.container.style.opacity = '0';
        this.container.style.transform = 'translateY(20px)';
        
        // Fade background to white
        setTimeout(() => {
          this.body.style.backgroundColor = '#ffffff';
          
          // Reset form and restart sequence
          setTimeout(() => {
            this.resetForm();
            this.isTransitioning = false;
            this.startSequence();
          }, 1000);
        }, 500);
      }
      
      /**
       * Reset form to initial state
       */
      resetForm() {
        // Clear inputs
        this.usernameInput.value = '';
        this.passwordInput.value = '';
        
          // Reset button to default
          this.updateButtonColor('default', 'cadastre-me');

        // Reset styles and visibility
        this.usernameInput.classList.remove('fade-in');
        this.actionBtn.classList.remove('fade-in');
        this.passwordGroup.classList.remove('fade-in');
        this.passwordGroup.classList.add('hidden');
        this.passwordInput.classList.remove('fade-in');
        
        
        // Reset container
        this.container.style.opacity = '0';
        this.container.style.transform = 'translateY(20px)';
        this.container.style.pointerEvents = 'all';
      }
      
      /**
       * Handle window resize for responsiveness
       */
      handleResize() {
        // Adjust image size on resize
        const width = window.innerWidth;
        if (width < 768) {
          this.demoImage.style.maxWidth = '250px';
          this.demoImage.style.maxHeight = '250px';
        } else {
          this.demoImage.style.maxWidth = '300px';
          this.demoImage.style.maxHeight = '300px';
        }
      }
    }
    
    // Initialize the application when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      new UIDemoController();
    });
  </script>
